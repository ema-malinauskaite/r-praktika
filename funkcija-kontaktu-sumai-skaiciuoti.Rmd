---
title: "fun_kontaktu_sumai"
author: "Ema Malinauskaite"
date: "2/12/2020"
output: html_document
---

```{r include=FALSE}
library("tidyverse")
library("data.table")
library("compareDF")
library("tidyr")
```

# Funkcijos kurimas

```{r}
fun_kontaktu_sumai <- function(liz_kont, nul_lentele_plat) { #pirmas kintamasis kontaktu lentele, antras nuline lentele

liz_kont_matrica <- as.matrix(data.frame(ar_1 = liz_kont$V6, ar_2 = liz_kont$V13))

surusiuoti_pavad <- liz_kont_matrica %>% 
  split(., row(.)) %>% sapply(
  . %>% sort %>% paste(collapse = "_")
) %>% data.frame

kont_sumos<- cbind(liz_kont, surusiuoti_pavad) %>% 
  rename(kontakto_tipas = ".") %>% 
  group_by(kontakto_tipas) %>% 
  summarise(kontakto_suma = sum(V15)) 

kont_sumos_plat <- spread(kont_sumos, kontakto_tipas, kontakto_suma)

sujungta <- full_join(nul_lentele_plat, kont_sumos_plat) %>% 
  gather() %>% 
  group_by(key) %>% 
  summarise(kontakto_suma = sum(value)) %>% 
  mutate_all(~replace(., is.na(.), 0)) %>% 
  spread(., key, kontakto_suma)

return(sujungta)
}
```

## Bandymas
Duomenu ikelimas:
```{r}
lizocimo_kontaktai <- data.table::fread("./wtx/1L63.contacts.interresidue.table")
nuline_lentele_platusis <- readr::read_rds("./data/nuline_lentele_platusis.rds")
```

```{r}
paruosta_lentele <- fun_kontaktu_sumai(lizocimo_kontaktai, nuline_lentele_platusis)

#readr::write_rds(paruosta_lentele, "./data/wtx_platusis.rds")
paruosta_lentele
```

# Funkcija kontaktu sumu skirtumu matricai ir temperaturu skirtumu matricoms sudaryti, kurios turetu tiek pat eiluciu

## Paruosiamoji dalis, reikalingu kenteliu kurimas:

Bandymui bus naudojama wt = wt temperaturu lentele, kurioje isfiltruoti tiek pdb na, tiek tm na ir paimtos pirmos 6 eilutes.

Duomenu ikelimas:
```{r}
lizocimai_pagr <- readxl::read_excel("./data/pro_344_sm_suppinfo.xlsx", sheet = "pilnas") %>%
  as.data.frame(stringsAsFactors = FALSE)
names(lizocimai_pagr) <- make.names(names(lizocimai_pagr))

wt_platusis <- readr::read_rds("./data/wt_platusis.rds")
```

Duomenų tvarkymas:
```{r}
lizocimai_pagr <- lizocimai_pagr %>%
  mutate(WT = ifelse((str_detect(Protein, "WT\\*")) == TRUE, "wtx", "wt")) %>% 
  select(-Protein, -Activity, -Space.group, -Reoslution..A., -Comment, -Tm) %>% 
  rename(pdb = PDB.code, deltaTm = ΔTm, ddeltaG = ΔΔG ) %>% 
  mutate_if(is.character, as_factor)
```

Apskaiciuojamos temperaturos (ne temperaturu skirtumai):
```{r}
lizocimai_pagr <- lizocimai_pagr %>%
  mutate(Tm = if_else(WT == "wt", deltaTm + 67.2, deltaTm + 65.8))

head(lizocimai_pagr)
```

```{r}
pdb_tm_wt <- lizocimai_pagr %>% 
  filter(WT == "wt") %>% 
  select(pdb, Tm) %>% 
  drop_na(pdb, Tm) %>% 
  head()

pdb_tm_wt
```

## Funkcija
Si funkcija, su duotais inputais cikle pirmiausiai turetu ir pbd_termo pasiimti pirmo baltymo pdb ir perleisti per fun_kontaktu_sumai. Tada, kai turi standartizuota baltymo kontaktu lentele, ja reiketu prideti prie WT lenteles, kadangi jos abi yra placiuoju formatu, naudoti full_join kad sutikrintu pagal stulpeliu pavadinimus. 
Pavertus i ilgaji formata lenteleje su funkcija summarise suskaiciuoti skirtuma tada paversti i platuju formata vel ir prideti prie bendros lenteles kur kiekvienoj eilutej bus dvieju baltymu kontaktu skirtumas, o stulpely kontakto tipas. Po ciklo tokia lentele reiktu paversti matrica. Taip pat ciklo metu reiktu paimti temperatura, ja atimti is wt temperaturos ir prideti i kita lentele, kuri irgi bus naudojama tiesinems lygtims. outputas turetu buti dvi matricos: viena kuri turi 230 stulpeliu ir tiek eiluciu, kiek yra baltymu, kita tureti tik viena stulpeli pasirinktam termodinaminiam parametrui ir tiek pat eiluciu kaip ir kita matrica.



```{r}
#input:
pdb_termo <- pdb_tm_wt #lentele, kurioje vienas stulpelis pasirinktas termodinaminis parametras, kitas stulpelis pdb failo pavadinimas

WT <- wt_platusis #sutvarkyta pasirinkto wt placiojo formato, su kuriuo bus lyginami kiti baltymai lentele su kontaktu plotu sumomis

nul_lent <- nuline_lentele_platusis

#funkcijos vidus:

# pdb <- pdb_termo %>% 
#   select(pdb)

for(i in pdb_termo$pdb) {
  
lizocimo_kontaktai <- data.table::fread(paste("./wt/",i,".contacts.interresidue.table", sep = ""))

kontaktu_sumos <- fun_kontaktu_sumai(lizocimo_kontaktai, nul_lent)

 wt_ir_lizocimas <- rbind(WT, kontaktu_sumos) #%>%
#   .[1,] - .[2, ]
#  gather()

#   group_by(key) %>% 
#   summarise(kontakto_sumu_skirtumas =  %>% 
#   mutate_all(~replace(., is.na(.), 0)) %>% 
#   spread(., key, kontakto_suma)

print(wt_ir_lizocimas)
lizocimo_kontaktai = NULL

}

```


```{r}
 # Create a vector filled with random normal values
u1 <- rnorm(30)
print("This loop calculates the square of the first 10 elements of vector u1")

# Initialize `usq`
usq <- 0

for(i in 1:10) {
  # i-th element of `u1` squared into `i`-th position of `usq`
  usq[i] <- u1[i]*u1[i]
  print(usq[i])
}

print(i)
```



