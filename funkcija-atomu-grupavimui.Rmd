---
title: "fun_atomu_grupavimui"
author: "Ema Malinauskaite"
date: "2/12/2020"
output: html_document
---

```{r include=FALSE}
library("tidyverse")
library("data.table")
library("compareDF")
library("tidyr")
library("matlib")
```

# fun_atomams_grupuoti

Si funkcija turetu paimti jau su padarytais pavadinimais esancia funkcija ir ciklo pagalba, tikrinti kiekvienos eilutes du paskutinius kintamuosius. Visus kintamojo pavadinimus kurie yra nuo 2 iki paskutinio stulpelio turetu keisti i failo pirmame stulpelyje esancius pavadinimus.
Ateityje galbut si funkcija arba papildoma funkcija galetu paimti visus esancius atomu tipus ir su jais paskaiciuoti, isspresti tiesine lygciu sistema, o rezultatus issaugoti, taip butu galima tureti daug sprendiniu-koeficientu failu, su kuriias galima toliau atlikti statistikas ir tikrinti tiksluma.

Yra lyg ir du lygiai: pirmiausiai yra visa lentele su skirtingom eilutem, tai nuskaicius lentele reiktu ciklo kuris skaito ta lentele po viena eilute, tuomet reiktu ciklo cikle kad ta eilute nuskaitytu po viena stulpeli, ir tikrintu, ar faile ar_1 ar ar_2 nera jo ir pakeistu i eilutes pavadinima (j)

```{r}
fun_atomams_grupuoti <- function(liz_kont, grupavimo_failas) { #pirmas kintamasis- kontaktu failas su pridetais pavadinimais ar1_atom1, 
  
#-------
# atomu pervadinimas pilnesniu pavadinimu
  
  kontaktai_atomu_pavadinimai <- liz_kont %>%
  select(V6, V7, V13, V14, V15) %>% 
  filter(V13 != ".") %>% 
  filter(V7 != "OXT") %>% #!!!!!!!!!!!!!!!!!
  filter(V14 != "OXT") %>% #!!!!!!!!!!!!!!!!!
  mutate(V6 = recode_factor(V6,"MSE" = "MET")) %>% 
  mutate(V13 = recode_factor(V13,"MSE" = "MET"))
  
kontaktai_atomu_pavadinimai$ar1_atom1 <- with(kontaktai_atomu_pavadinimai, paste0(V6,V7))
kontaktai_atomu_pavadinimai$ar2_atom2 <- with(kontaktai_atomu_pavadinimai, paste0(V13,V14))

#------
# grupes priskyrimas kiekvienam atomui
grupavimo_lentele <- grupavimo_failas %>% 
  mutate_all(na_if,"") %>% 
  tibble::column_to_rownames(var = "V1")
grupes_pavadinimai <- rownames(grupavimo_lentele) 

kontaktai_atomu_pavadinimai <- kontaktai_atomu_pavadinimai %>%
  mutate(grupe1 = 0) %>% 
  mutate(grupe2 = 0)

for (i in grupes_pavadinimai) {
  viena_eilute <- grupavimo_lentele[i,]
  viena_eilute <- viena_eilute[,colSums(is.na(viena_eilute)) == 0]
    for (j in viena_eilute) { 
        kontaktai_atomu_pavadinimai <- kontaktai_atomu_pavadinimai %>%
        mutate(grupe1 = ifelse(ar1_atom1 == j, i, grupe1)) %>% 
        mutate(grupe2 = ifelse(ar2_atom2 == j, i, grupe2))
    }
}
#-----
#Isrusiuotu pavadinimu grupe1-grupe2 sudarymas ir kontakto sumu skaiciavimas pagal grupes
matrica_pavadinimams <- as.matrix(data.frame(grupe1 = kontaktai_atomu_pavadinimai$grupe1, grupe2 = kontaktai_atomu_pavadinimai$grupe2))

surusiuoti_pavad <- matrica_pavadinimams %>% 
  split(., row(.)) %>% sapply(
  . %>% sort %>% paste(collapse = "-")
) %>% data.frame

atom_kont_sumos <- cbind(kontaktai_atomu_pavadinimai, surusiuoti_pavad) %>% 
  rename(kontakto_tipas = ".") %>% 
  group_by(kontakto_tipas) %>% 
  summarise(kontakto_suma = sum(V15)) 

#-----
# Nulines lenteles kurimas ir jos pridejimas prie sumu lenteles
#reik nulines lenteles, kuri sukuriama is pavadinimu failo, kad butu galima sulyginti ivairiu baltymu duomenis, joje turetu bu visi imanomi grupiu tipai kaip stulpeliu pavadinimai, o stulpelio pirmoje eiluteje nuliai

# Kodas apacioje yra senas, jis sujungia nuline lentele su normalia lentele isrusiuotais pavadinimais, tai yr atliekama tada, kai jau suskaiciuojamos sumos ir nesidubliuoja viariantai.
# kont_sumos_plat <- spread(kont_sumos, kontakto_tipas, kontakto_suma)
# 
# sujungta <- full_join(nul_lentele_plat, kont_sumos_plat) %>% 
#   gather() %>% 
#   group_by(key) %>% 
#   summarise(kontakto_suma = sum(value)) %>% 
#   mutate_all(~replace(., is.na(.), 0)) %>% 
#   spread(., key, kontakto_suma

#----------
return(atom_kont_sumos)
}

```

## Bandymas

duomenu ikelimas:
```{r}
lizocimo_atom_kontaktai_1L63 <- data.table::fread("./lizocimai/1L63.contacts.interatom.table")

#pavyzdiniai atomu tipu duomenys
grupavimo_failas <- data.table::fread(
  "/Users/user/Desktop/praktika/r-praktika/atom types/FTA.atoms",
  dec = ".", header = FALSE, skip = 1, encoding = "UTF-8", fill = TRUE,
  data.table = FALSE
)
```

```{r}
rezultatai <- fun_atomams_grupuoti(lizocimo_atom_kontaktai_1L63, grupavimo_failas)
rezultatai
```











